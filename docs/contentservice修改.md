# Content Service 问题总结

本文档记录了当前 Content Service 在设计和实现层面存在的一些问题，便于后续优化和演进。

## 1. 接口职责边界不清晰
- **审核与课程基本信息混杂**  
  - 当前在 CourseController 中，审核相关接口（提交审核、审核、重新提交审核）与课程基础信息（CourseBase）接口混合在一起。
  - 实际审核业务涉及预发布数据（CoursePublishPre）、正式发布数据（CoursePublish）与课程基础数据（CourseBase），职责不明确导致维护和扩展变得困难。

- **路由和权限问题**  
  - 不同角色（管理员、审核人员、机构用户）的接口不统一，例如部分审核接口和课程管理接口共用相同的路径，容易造成混淆。
  - 建议：考虑拆分审核模块或控制器，将审核相关接口单独管理，并对路由进行明确分组。

## 2. DTO 设计存在重复与耦合问题
- **字段重复**  
  - 针对课程创建、编辑、审核、预览等场景分别定义了 AddCourseDTO、EditCourseDTO、CourseAuditDTO、CoursePreviewDTO 等对象，但其中存在大量重复字段，如课程名称、简介、分类信息等。
  - 建议：抽取公共字段或基类，提升 DTO 的复用性，减少后续需求变动时的遗漏。

- **字段命名与校验不统一**  
  - 部分 DTO 的注解校验（如 @NotEmpty、@NotNull）及 Swagger 描述（@Schema）不够一致，可能导致前后端对字段含义的理解不统一。

- **树形结构字段命名不统一**  
  - 如 TeachplanDTO 中所用的子节点字段命名为 teachPlanTreeNodes，与其他树形结构 DTO 可能存在名称上不一致的问题，影响数据映射和前端显示。

## 3. 数据转换和树形结构构建隐患
- **树形结构构建顺序问题**  
  - 在构建课程计划树（Teachplan）的过程中，当前逻辑依赖遍历时父节点早于子节点出现。若数据插入顺序不一致，会导致无法找到父节点，从而使树形结构不完整。
  - 建议：先整理所有记录到 Map 中，再构建树形结构，确保父子关系正确映射。

- **ModelMapper 使用问题**  
  - 对 DTO 与实体之间的转换使用 ModelMapper，缺乏自定义配置，可能在处理复杂字段和层级结构转换时出错，后续维护调试难度较大。

## 4. 分布式操作与事务问题
- **排序调整的性能瓶颈**  
  - 移动操作（moveUp、moveDown）涉及多条记录的更新，目前没有使用批量更新，数据量较大时可能引发性能问题。
  - 建议：引入缓存机制暂存调整信息，待节点移动操作批量提交时，统一更新数据库。

- **事务处理和数据一致性**  
  - 大量分布式或批量操作下，如何保证事务一致性和数据正确性需要进一步设计完善，尤其在引入缓存机制后需要考虑缓存与数据库的一致性同步问题。

## 5. 接口命名与业务模型不符
- **审核接口设计冲突**  
  - 当前审核接口设计基于 CourseBase 数据，而实际审核应展示 CoursePublishPre 数据，导致审核操作时需要额外查询其他表。
  - 建议：重新梳理审核流程设计，使审核人员能够直观地看到所有课程状态数据，并清晰区分预发布与发布数据。

总体来说，当前的 Content Service 在模块划分、接口设计、DTO 复用、数据转换和事务处理等方面，还有很大的优化空间。后续可以从以下几个方面着手改进：
- 拆分 Controller，明确业务职责；
- 提取公共 DTO 基类，减少字段重复；
- 优化数据转换逻辑，确保层级关系正确；
- 引入缓存与批量处理优化分布式操作；
- 重新设计审核接口，更好地支撑业务流程。

以上为当前存在的问题详细描述，供后续解决方案参考。
# 逐步解决方案

下面以逐步执行的方式描述解决当前问题的方法，以便你在实现每一步后确认是否正确。

## 步骤1：拆分 Controller，明确接口职责

1. **确定核心业务模块**  
   - 课程管理（CourseBase 相关）  
   - 课程审核（审核流程涉及 CoursePublishPre 和 CoursePublish）  
   - 课程计划（Teachplan 及排序调整相关）  
   - 媒资、教师管理等可以保持现有模块分离

2. **拆分审核 Controller**  
   - 创建新的 `AuditController` 或 `CourseAuditController`，只处理审核相关接口  
   - 将审核相关的路由（如提交审核、审核课程、重新提交审核等）从原来的 `CourseController` 中迁移出去  
   - 统一审核接口数据来源，例如审核人员看到的接口直接操作预发布数据（CoursePublishPre）

3. **路由分组与权限设计**  
   - 为不同角色设计不同 URI 前缀（如 `/admin/course`、`/audit/course`、`/organization/course`）  
   - 校验相应角色权限，确保接口调用与业务定位一致

## 步骤2：优化 DTO 设计

1. **抽取公共基类**  
   - 分析 `AddCourseDTO`、`EditCourseDTO`、`CoursePreviewDTO`、`CourseAuditDTO` 中的重复字段  
   - 创建一个基类（如 `CourseBaseInfoDTO`），把这些公共字段放在基类中  
   - 子类 DTO 继承该基类并根据需要添加特定字段

2. **统一字段命名与校验**  
   - 检查 DTO 中的字段校验注解（比如 @NotEmpty、@NotNull）和 Swagger 的 @Schema 描述  
   - 统一命名规范，特别是树形结构中的子节点字段建议统一为 `children` 或同一命名

3. **完善注释与文档**  
   - 在 DTO 中补充详细的字段描述，确保前后端理解一致  

## 步骤3：改进数据转换和树形结构构建

1. **调整树形结构构建逻辑**  
   - 不再依赖遍历顺序确定父子关系，而是：
     - 遍历所有 Teachplan 记录，存入 Map（以 ID 为键）  
     - 再次遍历 Map，按照 parentId 关系为父节点添加子节点  
     - 这种方式确保无论插入顺序如何，都能正确构建树形结构

2. **自定义 ModelMapper 配置（或替换工具）**  
   - 对复杂或嵌套字段制定自定义 Converter  
   - 把转换规则集中管理，便于后续调试和扩展  

## 步骤4：优化分布式操作与事务处理

1. **引入缓存机制改善排序调整**  
   - 对于课程计划的移动调整（moveUp、moveDown），可以使用 Redis 或其他内存缓存  
   - 当进行操作时，先将变动记录写入缓存，并在达到一定阈值或在事务提交后批量更新数据库  
   - 需要考虑缓存与数据库的数据一致性问题

2. **事务优化**  
   - 为批量更新操作设置合适的事务和锁机制  
   - 使用乐观锁或版本号控制，确保并发下数据的正确性

## 步骤5：重新梳理审核业务逻辑

1. **数据来源确认**  
   - 确认审核接口数据应以 CoursePublishPre 为主，结合 CourseBase 对数据进行补充  
   - 设计审核过程中需要显示的完整信息（审核意见、审核人员信息、审核时间等）

2. **接口粒度细化**  
   - 设计审核查询接口，支持跨表联合查询，并返回审核完整数据  
   - 将审核操作与课程发布解耦，保证审核流程直观明了

3. **日志和追踪支持**  
   - 在审核操作中添加详细日志记录，便于后续查询和问题排查  
   - 保留审核记录，以支持历史版本对比和审核轨迹审计

---

按照上述步骤逐步调整，将能有效解决接口职责不清、DTO 重复、数据转换隐患以及事务操作性能问题。你可以按照这些步骤检验当前实现，并逐步验证每个改进方案的效果。
# 鉴权讨论

在认证服务器搭建之前，可以考虑初步引入鉴权逻辑，主要有以下几点方案和建议：

1. **先行集成 Spring Security**  
   - 可以在各微服务中配置 Spring Security，为静态资源和接口加入基本保护。
   - 在配置中先开发简单的用户名密码和角色校验，后期再迁移到 OAuth2 认证。

2. **引入 JWT 作为临时方案**  
   - 可以利用 JWT 搭建一个轻量级的鉴权机制，使服务保持无状态。
   - JWT 中存储基本的用户信息和权限，在后续接入 OAuth2 认证服务器时，替换生成和验证的服务即可。

3. **使用 Spring Cloud Security 模块**  
   - 建议在开发初期使用 Spring Cloud Security 提供的功能，确保微服务间的安全通信。
   - 后续整合 OAuth2 认证服务器时，需要注意对 JWT 的生成、解析和刷新做适当调整。

4. **权限策略和接口隔离**  
   - 尽可能先定义好各模块的角色权限（例如管理员、审核人员、机构用户）。
   - 配置 Spring Security 拦截器，先行实现基于角色的访问控制，确保在认证服务器未上线之前，安全策略能起到基本作用。

总的来说，在认证服务器搭建之前引入鉴权框架是可行的，既可以保护接口安全，也为后续整合 OAuth2 认证提供了良好基础。当前采用基于 Spring Security 与 JWT 的无状态方案，是一个较好的过渡方案，在后续完善认证服务器后，再整体切换到 OAuth2 认证模式。